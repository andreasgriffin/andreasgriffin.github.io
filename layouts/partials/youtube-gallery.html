{{ $videos := .videos }}
{{ $page := .Page }}
{{ if and $videos (gt (len $videos) 0) }}
  {{/* Decide the primary video once so we can declare a single watch-page VideoObject. */}}
  {{ $primary := index $videos 0 }}
  {{ if eq (printf "%T" $primary) "string" }}
    {{ $primary = dict "url" $primary }}
  {{ end }}

  {{ $primaryUrl := $primary.url }}
  {{ $primaryName := $page.Title }}
  {{ $primaryDesc := or $primary.description $page.Params.description }}
  {{ with $primary.name }}{{ $primaryName = . }}{{ end }}
  {{ if not $primaryDesc }}{{ $primaryDesc = $primaryName }}{{ end }}

  {{/* --- uploadDate as ISO-8601 with timezone --- */}}
  {{ $uploadTime := now }}
  {{ with $page.Date }}{{ $uploadTime = . }}{{ end }}
  {{ with $primary.uploadDate }}{{ $uploadTime = time . }}{{ end }}
  {{ $upload := time.Format "2006-01-02T15:04:05Z07:00" $uploadTime }}

  {{/* --- robust YouTube ID extraction --- */}}
  {{ $primaryId := replaceRE `(?i)^.*(?:v=|youtu\.be/|shorts/|embed/)([A-Za-z0-9_-]{11}).*$` `$1` $primaryUrl }}
  {{ if ne (len $primaryId) 11 }}
    {{ $m := findRE `[A-Za-z0-9_-]{11}` $primaryUrl }}
    {{ if gt (len $m) 0 }}{{ $primaryId = index $m 0 }}{{ end }}
  {{ end }}
  {{ $primaryEmbed := printf "https://www.youtube-nocookie.com/embed/%s" $primaryId }}
  {{ $primaryThumb := printf "https://i.ytimg.com/vi/%s/hqdefault.jpg" $primaryId }}

  <div class="container my-5">
    <div class="row">
      {{ range $videos }}
        {{ $video := . }}
        {{ if eq (printf "%T" $video) "string" }}
          {{ $video = dict "url" $video }}
        {{ end }}
        {{ $videoUrl := $video.url }}
        {{ $name := or $video.name $page.Title }}
        {{ if not $name }}{{ $name = "Video" }}{{ end }}

        {{/* --- robust YouTube ID extraction for rendering --- */}}
        {{ $id := replaceRE `(?i)^.*(?:v=|youtu\.be/|shorts/|embed/)([A-Za-z0-9_-]{11}).*$` `$1` $videoUrl }}
        {{ if ne (len $id) 11 }}
          {{ $m := findRE `[A-Za-z0-9_-]{11}` $videoUrl }}
          {{ if gt (len $m) 0 }}{{ $id = index $m 0 }}{{ end }}
        {{ end }}
        {{ $embedUrl := printf "https://www.youtube-nocookie.com/embed/%s" $id }}

        <div class="col-md-12 mb-4 text-center">
          <div class="ratio ratio-16x9" style="max-width:800px; margin:0 auto;">
            <iframe src="{{ $embedUrl }}"
                    title="{{ $name }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen>
            </iframe>
          </div>
        </div>
      {{ end }}
    </div>
  </div>

  {{/* --- Single JSON-LD VideoObject to signal this page is a watch page. --- */}}
  {{ if eq (len $primaryId) 11 }}
    {{ $schema := dict
        "@context" "https://schema.org"
        "@type" "VideoObject"
        "@id" (printf "%s#video" $page.Permalink)
        "mainEntityOfPage" (dict "@id" $page.Permalink)
        "isPartOf" (dict "@id" $page.Permalink)
        "name" $primaryName
        "description" $primaryDesc
        "thumbnailUrl" (slice $primaryThumb)
        "embedUrl" $primaryEmbed
        "contentUrl" $primaryUrl
        "url" $page.Permalink
        "uploadDate" $upload
        "potentialAction" (dict "@type" "WatchAction" "target" (slice $primaryEmbed $primaryUrl))
    }}
    <script type="application/ld+json">
    {{ $schema | jsonify | safeJS }}
    </script>
  {{ end }}
{{ else }}
  <p>No videos provided.</p>
{{ end }}
